@using SENSEI.DOMAIN

@model StudentRegistration

@{
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
    ViewData["Title"] = "Register";
}


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    /* Sakura Theme Matching Home Page */
    :root {
        --bg-main: #fffbfb;
        --primary: #ff5a5f;
        --primary-dark: #d93d42;
        --accent-sakura: #ffeff0;
        --text-main: #1a1a1a;
        --text-muted: #555555;
        --border-soft: #ffe5e5;
    }

    body {
        background: linear-gradient(to bottom, #fffbfb 0%, #fff5f5 100%) !important;
        position: relative;
    }

    /* Sakura Background Decorations */
    body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
        pointer-events: none;
        background-image: url('/theme/v1/img/photos/sakura.png'), url('/theme/v1/img/photos/sakura.png');
        background-repeat: no-repeat, no-repeat;
        background-position: -5% -5%, 105% 60%;
        background-size: 500px auto, 600px auto;
        opacity: 0.12;
        mix-blend-mode: multiply;
    }

    .card {
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 90, 95, 0.15) !important;
        border-radius: 20px !important;
        box-shadow: 0 20px 50px rgba(255, 90, 95, 0.08) !important;
        margin-bottom: 2rem;
        border: none;
    }

    .card-header {
        background: rgba(255, 90, 95, 0.03) !important;
        border-bottom: 1px solid rgba(255, 90, 95, 0.1) !important;
        padding: 1.25rem 1.5rem !important;
        border-top-left-radius: 20px !important;
        border-top-right-radius: 20px !important;
    }

    .card-title {
        color: var(--primary) !important;
        font-weight: 800 !important;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.95rem !important;
        margin-bottom: 0 !important;
    }

    .btn-primary {
        background: var(--primary) !important;
        border: none !important;
        border-radius: 12px !important;
        padding: 1rem 2.5rem !important;
        font-weight: 700 !important;
        box-shadow: 0 8px 20px rgba(255, 90, 95, 0.3) !important;
        transition: all 0.3s ease !important;
    }

    .btn-primary:hover {
        background: var(--primary-dark) !important;
        transform: translateY(-2px);
        box-shadow: 0 12px 25px rgba(255, 90, 95, 0.4) !important;
    }

    .btn-back {
        display: inline-flex;
        align-items: center;
        color: var(--text-muted);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid var(--border-soft);
        transition: all 0.2s ease;
        margin-top: 1.5rem;
    }

    .btn-back:hover {
        color: var(--primary);
        background: var(--accent-sakura);
        border-color: var(--primary);
        transform: translateX(-5px);
        text-decoration: none;
    }

    h1 {
        font-weight: 900 !important;
        color: var(--text-main) !important;
        letter-spacing: -0.02em;
    }

    .form-label {
        font-weight: 700;
        color: var(--text-main);
        font-size: 0.88rem;
        margin-bottom: 0.4rem;
    }

    .form-control, .form-select {
        height: 48px !important;
        border-radius: 12px !important;
        border: 1px solid #ffe0e0 !important;
        padding: 0.72rem 1rem !important;
        background: #fff !important;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 4px rgba(255, 90, 95, 0.1) !important;
        background: #fff !important;
    }

    /* Select2 Dropdown Visibility Fix */
    .select2-container {
        z-index: 9999 !important;
        display: block !important;
        width: 100% !important;
    }

    .select2-container .select2-selection--single {
        height: 48px !important;
        border-radius: 12px !important;
        border: 1px solid #ffe0e0 !important;
        background: #fff !important;
        display: flex !important;
        align-items: center !important;
        padding-left: 8px !important;
        position: relative !important;
    }

    .select2-container--bootstrap5 .select2-selection--single .select2-selection__rendered {
        color: var(--text-main) !important;
        line-height: normal !important;
        padding-left: 4px !important;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .select2-container--bootstrap5 .select2-selection--single .select2-selection__arrow {
        position: absolute !important;
        right: 15px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        width: 20px !important;
        height: 20px !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ff5a5f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        background-size: 12px !important;
    }

    .select2-container--bootstrap5 .select2-selection--single .select2-selection__clear {
        position: absolute !important;
        right: 40px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        margin-top: 0 !important;
        background: none !important;
        font-weight: bold !important;
        font-size: 1.2rem !important;
        color: #ff8a8f !important;
        cursor: pointer !important;
        z-index: 10 !important;
    }

    .select2-container--bootstrap5 .select2-selection--single .select2-selection__clear:hover {
        color: var(--primary) !important;
    }

    .select2-dropdown {
        background: #fff !important;
        border: 1px solid #ffd8c5 !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 30px rgba(255, 90, 95, 0.15) !important;
        z-index: 99999 !important; /* Extremely high to beat any other layers */
    }

    /* ITI Override to prevent overlap */
    .iti { width: 100%; display: block; }
    
    /* Phone Number dropdown styling when opening in document.body */
    .iti__country-list { 
        z-index: 99999 !important; 
        background-color: #ffffff !important;
        border: 1px solid #ffd8c5 !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 30px rgba(255, 90, 95, 0.15) !important;
        max-height: 280px !important;
    }
    
    .iti input#PhoneNo {
        padding-left: 95px !important; 
        height: 48px !important;
    }
    
    .iti--separate-dial-code .iti__selected-dial-code {
        margin-left: 8px;
        font-weight: 700;
        color: var(--primary);
    }
</style>

<!-- intl-tel-input -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@23.0.1/build/css/intlTelInput.css">

<div class="container d-flex flex-column">

    <div class="d-flex justify-content-start align-items-center">
        <a href="@Url.Action("Index", "SenseiJapaneseSchool")" class="btn-back">
            <i class="fas fa-chevron-left me-2"></i> Back to Home
        </a>
    </div>

    <div class="text-center mb-5 mt-4">
        <h1 class="display-5">Student Online Registration 🌸</h1>
        <p class="text-muted">Join our community and start your journey to Japanese fluency today.</p>
    </div>

    <form asp-action="Register" asp-controller="SenseiJapaneseSchool" asp-area="" method="post" id="student-register">

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Personal Information</h5>
                    </div>
                    <div class="card-body">

                        <div class="row">

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="Initials"></label>
                                @Html.TextBoxFor(m => m.Initials, new { @class = "form-control", placeholder = "e.g. A.B.C." })
                                <span asp-validation-for="Initials" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="FirstName">First Name *</label>
                                @Html.TextBoxFor(m => m.FirstName, new { @class = "form-control", placeholder = "Enter first name" })
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="MiddleName"></label>
                                @Html.TextBoxFor(m => m.MiddleName, new { @class = "form-control", placeholder = "Enter middle name (Optional)" })
                                <span asp-validation-for="MiddleName" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="LastName">Last Name *</label>
                                @Html.TextBoxFor(m => m.LastName, new { @class = "form-control", placeholder = "Enter last name" })
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="CallingName"></label>
                                @Html.TextBoxFor(m => m.CallingName, new { @class = "form-control", placeholder = "Name you want to be called" })
                                <span asp-validation-for="CallingName" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="NIC"></label>
                                @Html.TextBoxFor(m => m.NIC, new { @class = "form-control", placeholder = "National Identity Card No" })
                                <span asp-validation-for="NIC" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="DateOfBirth">Date Of Birth *</label>
                                @Html.TextBoxFor(m => m.DateOfBirth, new { @class = "form-control datepicker", placeholder = "YYYY-MM-DD" })
                                <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="card-title mb-0 fw-bold">Contact Information</h5>
                    </div>
                    <div class="card-body py-4">

                        <div class="row g-3">

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="AddressLineOne"></label>
                                @Html.TextBoxFor(m => m.AddressLineOne, new { @class = "form-control", placeholder = "Street address, P.O. box, etc." })
                                <span asp-validation-for="AddressLineOne" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="AddressLineTwo"></label>
                                @Html.TextBoxFor(m => m.AddressLineTwo, new { @class = "form-control", placeholder = "Apartment, suite, unit, building, floor, etc. (Optional)" })
                                <span asp-validation-for="AddressLineTwo" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="PostalCode"></label>
                                @Html.TextBoxFor(m => m.PostalCode, new { @class = "form-control", placeholder = "Postal / Zip Code (Optional)" })
                                <span asp-validation-for="PostalCode" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12">
                                <div class="mb-3" id="country-wrapper">
                                    <label class="form-label" asp-for="CountryCode">Country *</label>
                                    <select id="CountryId" class="form-control country-select" name="CountryCode" asp-for="CountryCode"></select>
                                    <span asp-validation-for="CountryCode" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12">
                                <div class="mb-3">
                                    <label class="form-label" asp-for="State"></label>
                                    @Html.TextBoxFor(m => m.State, new { @class = "form-control", placeholder = "State / Province / Region (Optional)" })
                                    <span asp-validation-for="State" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12">
                                <div class="mb-3">
                                    <label class="form-label" asp-for="City">City *</label>
                                    @Html.TextBoxFor(m => m.City, new { @class = "form-control", placeholder = "City" })
                                    <span asp-validation-for="City" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label d-block" asp-for="PhoneNo">Phone Number *</label>
                                @Html.TextBoxFor(m => m.PhoneNo, new { @class = "form-control w-100", id = "PhoneNo", type = "tel" })
                                <span id="phone-error" class="text-danger d-none mt-1">Please enter a valid international phone number.</span>
                                <span asp-validation-for="PhoneNo" class="text-danger"></span>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                <label class="form-label" asp-for="Email">Email *</label>
                                @Html.TextBoxFor(m => m.Email, new { @class = "form-control", placeholder = "Email Address", type = "email" })
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="card-title mb-0 fw-bold">Course Information</h5>
                    </div>
                    <div class="card-body py-4">

                        <div class="row g-3">

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12">
                                <div class="mb-3" id="learningmode-wrapper">
                                    <label class="form-label" asp-for="StudentLearningModeId">Learning Mode *</label>
                                    <select id="StudentLearningModeId" class="form-control learningmode-select" name="StudentLearningModeId" asp-for="StudentLearningModeId"></select>
                                    <span asp-validation-for="StudentLearningModeId" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12" id="branch-field">
                                <div class="mb-3" id="branch-wrapper">
                                    <label class="form-label" asp-for="BranchId">Branch *</label>
                                    <select id="BranchId" class="form-control branch-select" name="BranchId" asp-for="BranchId"></select>
                                    <span asp-validation-for="BranchId" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12">
                                <div class="mb-3" id="course-wrapper">
                                    <label class="form-label" asp-for="CourseId">Course *</label>
                                    <select id="CourseId" class="form-control course-select" name="CourseId" asp-for="CourseId"></select>
                                    <span asp-validation-for="CourseId" class="text-danger"></span>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4 mb-5">
            <button type="submit" class="btn-primary" style="min-width: 250px;" id="btnRegister">
                <i class="fas fa-paper-plane me-2"></i> Complete Registration Now
            </button>
        </div>

    </form>
</div>

@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@23.0.1/build/js/intlTelInput.min.js"></script>

    <style>
        .iti { width: 100%; }
        .is-invalid + .iti { border: 1px solid #dc3545; border-radius: 0.25rem; }
        .form-control.is-invalid {
            border-color: #dc3545 !important;
            background-image: none !important;
        }
    </style>

    <script type="text/javascript">
    
        $(document).ready(function () {

            // Initialize Phone Input
            const phoneInputField = document.querySelector("#PhoneNo");
            const phoneError = document.querySelector("#phone-error");
            
            const iti = window.intlTelInput(phoneInputField, {
                initialCountry: "auto",
                geoIpLookup: callback => {
                    fetch("https://ipapi.co/json")
                        .then(res => res.json())
                        .then(data => callback(data.country_code.toLowerCase()))
                        .catch(() => callback("lk"));
                },
                utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@23.0.1/build/js/utils.js",
                separateDialCode: true,
                autoPlaceholder: "aggressive",
                formatOnDisplay: true,
                dropdownContainer: document.body // Fixes visibility/clipping issues
            });

            // Help Select2 data load
            const initCountryDropdown = (data) => {
                 loadSelectBox({
                    data: data,
                    className: 'country-select',
                    title: 'Select Country',
                    dropdownParentId: 'country-wrapper' // Re-added with better CSS
                });
            };

            const validatePhone = () => {
                if (phoneInputField.value.trim()) {
                    if (iti.isValidNumber()) {
                        phoneError.classList.add("d-none");
                        phoneInputField.classList.remove("is-invalid");
                        return true;
                    } else {
                        phoneError.classList.remove("d-none");
                        phoneInputField.classList.add("is-invalid");
                        return false;
                    }
                }
                return true; // Optional field bypass if empty, but here it's usually required
            };

            phoneInputField.addEventListener('blur', validatePhone);
            phoneInputField.addEventListener('change', validatePhone);

            // Sync Country Dropdown with Phone
            phoneInputField.addEventListener("countrychange", function() {
                const countryData = iti.getSelectedCountryData();
                if (countryData && countryData.iso2) {
                    $('#CountryId').val(countryData.iso2.toUpperCase()).trigger('change');
                }
            });

            // Load Countries
            $.getJSON('/SenseiJapaneseSchool/GetCountryListJsonResult', function (data) {
                initCountryDropdown(data);

                // Initial sync from ITI
                const countryData = iti.getSelectedCountryData();
                if (countryData && countryData.iso2) {
                    $('#CountryId').val(countryData.iso2.toUpperCase()).trigger('change');
                }
            });

            // Load Learning Modes
            $.getJSON('/SenseiJapaneseSchool/GetLearningModeListJsonResult', function (data) {
                loadSelectBox({
                    data: data,
                    className: 'learningmode-select',
                    title: 'Select Learning Mode',
                    dropdownParentId: 'learningmode-wrapper'
                });
            });

            // Load Courses
            $.getJSON('/SenseiJapaneseSchool/GetCourseListJsonResult', function (data) {
                loadSelectBox({
                    data: data,
                    className: 'course-select',
                    title: 'Select Course',
                    dropdownParentId: 'course-wrapper'
                });
            });

            // Load Branches
            $.getJSON('/SenseiJapaneseSchool/GetBranchListJsonResult', function (data) {
                loadSelectBox({
                    data: data,
                    className: 'branch-select',
                    title: 'Select Branch',
                    dropdownParentId: 'branch-wrapper'
                });
            });

            // Datepicker
            $('#DateOfBirth').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true,
                startView: 2,
                endDate: new Date()
            });

            // Form Validation Configuration
            $("#student-register").validate({
                errorClass: "text-danger",
                highlight: function(element) {
                    $(element).addClass("is-invalid");
                },
                unhighlight: function(element) {
                    $(element).removeClass("is-invalid");
                },
                submitHandler: function(form) {
                    if (validatePhone()) {
                        // Set full E.164 number before submit
                        phoneInputField.value = iti.getNumber();
                        form.submit();
                    } else {
                        window.notyf.error("Please correct the errors in the form.");
                        return false;
                    }
                }
            });

            // Sync phone with country dropdown change
            $('#CountryId').on('change', function() {
                const countryCode = $(this).val();
                if (countryCode) {
                    iti.setCountry(countryCode.toLowerCase());
                }
            });

        });
    </script>
}
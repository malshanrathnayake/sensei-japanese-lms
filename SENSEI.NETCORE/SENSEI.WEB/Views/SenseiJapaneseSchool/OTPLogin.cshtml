@{
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
    ViewData["Title"] = "Sign In";
}

<div class="container d-flex flex-column">
    <div class="row vh-100">
        <div class="col-sm-10 col-md-8 col-lg-6 col-xl-5 mx-auto d-table h-100">
            <div class="d-table-cell align-middle">

                <div class="text-center mt-4">
                    <h1 class="h2">Welcome back!</h1>
                    <p class="lead">Log in to your account via OTP</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="m-sm-3">

                            <form id="otpForm" asp-action="OTPLogin" asp-controller="SenseiJapaneseSchool" method="post">

                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>

                                    <div class="input-group">
                                        <span class="input-group-text">+94</span>
                                        <input type="text" class="form-control form-control-lg" id="phone" name="phone" placeholder="7XXXXXXXX" maxlength="9" />
                                    </div>

                                    <span class="text-danger d-block mt-1" id="phoneError"></span>
                                </div>


                                <div class="d-grid gap-2 mt-3">
                                    <button type="submit" class="btn btn-lg btn-primary">
                                        Sign in
                                    </button>
                                </div>

                            </form>

                        </div>
                    </div>
                </div>

                <div class="text-center mb-3">
                    Don't have an account? <a asp-controller="SenseiJapaneseSchool" asp-action="Register" class="btn btn-lg btn-primary"> Register </a>
                </div>

            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script type="text/javascript">

        $(document).ready(function () {

            const $phone = $("#phone");
            const $error = $("#phoneError");

            // Block non-numeric keys (no letters, no dots, no symbols)
            $phone.on("keypress", function (e) {
                let charCode = e.which ? e.which : e.keyCode;

                // Allow backspace (8)
                if (charCode === 8) return;

                // Allow only digits 0–9
                if (charCode < 48 || charCode > 57) {
                    e.preventDefault();
                }
            });

            // Prevent paste of non-numeric values
            $phone.on("paste", function (e) {
                let pasteData = e.originalEvent.clipboardData.getData("text");
                if (!/^\d+$/.test(pasteData)) {
                    e.preventDefault();
                    showError("Only numbers are allowed");
                }
            });

            // Live validation while typing
            $phone.on("input", function () {
                let value = $phone.val();

                // Remove any non-digits just in case
                value = value.replace(/\D/g, '');
                $phone.val(value);

                if (value.length === 0) {
                    $error.text("");
                    return;
                }

                if (value.startsWith("0")) {
                    showError("Number cannot start with 0");
                }
                else if (value.length > 9) {
                    showError("Maximum 9 digits allowed");
                }
                else if (value.length < 9) {
                    showError("Enter 9-digit mobile number without 0");
                }
                else {
                    clearError();
                }
            });

            // On submit validation
            $("#otpForm").submit(function (e) {
                let phone = $phone.val();

                if (!/^[1-9][0-9]{8}$/.test(phone)) {
                    e.preventDefault();
                    showError("Enter a valid 9-digit mobile number (without leading 0)");
                    return;
                }

                // Append country code before submit
                $phone.val("94" + phone);
            });

            function showError(message) {
                $error.text(message);
            }

            function clearError() {
                $error.text("");
            }
        });

    </script>
}

